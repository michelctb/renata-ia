
// Configuração do Webhook no n8n para Gerar e Enviar Relatórios Financeiros

// 1. CONFIGURAÇÃO DO N8N:
// ----------------------

// PASSO 1: Crie um novo fluxo de trabalho (workflow) no n8n
// - Clique em "Workflows" e depois "New"
// - Dê um nome como "Relatório Financeiro - Últimos 7 Dias"

// PASSO 2: Adicione um nó de gatilho "Webhook"
// - Configure para método POST
// - Salve e copie a URL gerada (será algo como https://your-n8n.com/webhook/abc123)

// PASSO 3: Adicione um nó HTTP Request após o Webhook
// - Método: POST
// - URL: https://preview--renata-ia.lovable.app/api/generate-report 
//   NOTA IMPORTANTE: Certifique-se de usar EXATAMENTE esta URL. Não use /dashboard ou qualquer outra rota.
// - Headers: 
//   - Content-Type: application/json
//   - Authorization: Bearer seu_token_de_api (se necessário)
// - Body (JSON): Envie os parâmetros necessários:
//   {
//     "clientId": "{{$json.clientId}}",
//     "reportType": "categorias",
//     "dateRange": {
//       "from": "{{$today.minus(7).format('YYYY-MM-DD')}}T00:00:00.000Z",
//       "to": "{{$today.format('YYYY-MM-DD')}}T23:59:59.999Z"
//     },
//     "includeCharts": true
//   }

// PASSO 4: Adicione um nó "Function" para depuração antes do JSON Parse
// - Este passo é crucial para verificar o que está vindo da API
// - Código JavaScript:
//   const response = $input.all();
//   console.log("Resposta bruta da API:", JSON.stringify(response));
//   
//   // Verificar se a resposta contém HTML (o que indicaria erro)
//   if (typeof response.data === 'string' && response.data.includes('<!DOCTYPE html>')) {
//     console.log("ERRO: Recebendo HTML em vez de JSON!");
//     throw new Error("API retornou HTML em vez de JSON. Verifique a configuração da API.");
//   }
//   
//   // Verificar se a resposta é um objeto JSON válido
//   if (typeof response.data === 'object' && response.data !== null) {
//     console.log("Resposta JSON válida recebida!");
//     console.log("Dados recebidos:", JSON.stringify(response.data));
//   }
//   
//   return response;

// PASSO 5: Adicione um nó "JSON Parse" após o Function
// - Configure para analisar dados na propriedade: data
// - Isso é importante para extrair os dados da resposta HTTP

// PASSO 6: Adicione um nó "IF" para verificar se a resposta foi bem-sucedida
// - Condição: {{$node["JSON Parse"].json["images"] !== undefined && $node["JSON Parse"].json["images"].length > 0}}

// PASSO 7: Adicione um nó de Email na rota "true" do IF
// - Para: {{$node["Webhook"].json.email}} (email do cliente que solicitou)
// - Assunto: Relatório Financeiro - Gastos por Categoria
// - Corpo: 
//   <h2>Relatório Financeiro</h2>
//   <p>Olá {{$node["Webhook"].json.nome}},</p>
//   <p>Segue o relatório financeiro dos últimos 7 dias conforme solicitado:</p>
//   
//   <h3>Gastos por Categoria:</h3>
//   <img src="{{$node["JSON Parse"].json.images[0].data}}" alt="Gráfico de categorias" />
//   
//   <h3>Ranking de Maiores Despesas:</h3>
//   <img src="{{$node["JSON Parse"].json.images[1].data}}" alt="Ranking de categorias" />
//   
//   <p>Acesse seu dashboard para mais detalhes.</p>
//   <p>Atenciosamente,<br>Sua Empresa</p>

// PASSO 8: Na rota "false" do IF, adicione um nó de Email para notificar erro
// - Para: {{$node["Webhook"].json.email}}
// - Assunto: Erro na geração do relatório
// - Corpo: Não foi possível gerar seu relatório. Por favor tente novamente mais tarde.

// DICAS DE DEPURAÇÃO:
// ----------------

// 1. Verifique a URL da API - Certifique-se que está usando a URL correta:
//    - CERTO: https://preview--renata-ia.lovable.app/api/generate-report
//    - ERRADO: https://preview--renata-ia.lovable.app/dashboard/api/generate-report
//    - ERRADO: https://preview--renata-ia.lovable.app/5cc683bb/api/generate-report

// 2. Teste a API diretamente com curl antes de configurar no n8n:
//    curl -v -X POST https://preview--renata-ia.lovable.app/api/generate-report \
//      -H "Content-Type: application/json" \
//      -d '{
//        "clientId": "5cc683bb",
//        "reportType": "categorias",
//        "dateRange": {
//          "from": "2023-10-01T00:00:00.000Z",
//          "to": "2023-10-07T23:59:59.999Z"
//        },
//        "includeCharts": true
//      }'
//
//    O parâmetro -v ativa o modo verbose, mostrando cabeçalhos e mais detalhes.

// 3. Verifique os logs do nó Function para ver a resposta exata da API:
//    - Se ainda estiver recebendo HTML, veja o conteúdo exato para entender o problema
//    - Busque por mensagens de erro no HTML que possam indicar o problema

// 4. Problemas comuns:
//    - Headers CORS: Verifique se a API está configurada para permitir CORS
//    - Método errado: Confirme se está usando POST e não GET
//    - Content-Type: Certifique-se que está enviando com Content-Type: application/json
//    - Formato do body: Verifique se o JSON está bem formatado

// FORMATO CORRETO DE RESPOSTA JSON:
// -----------------------------
// {
//   "meta": { ... metadados do relatório ... },
//   "dados": { ... dados para o relatório ... },
//   "images": [
//     {
//       "name": "grafico_categorias.png",
//       "data": "data:image/png;base64,iVBORw0KGgoAAAANSUhE..."
//     },
//     {
//       "name": "grafico_ranking.png", 
//       "data": "data:image/png;base64,iVBORw0KGgoAAAANSUhE..."
//     }
//   ]
// }

// 5. Soluções para quando ainda recebe HTML:
//    - Verifique se o arquivo src/pages/api/generate-report.ts existe e está corretamente implementado
//    - Certifique-se de que a URL está correta - deve ser /api/generate-report
//    - Tente um hard refresh no servidor (reinicie o servidor da aplicação)
//    - Verifique se não há redirecionamento na API que esteja enviando para a página principal

